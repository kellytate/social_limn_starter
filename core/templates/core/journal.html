{% extends 'base.html' %}

{% block content %}
<main>
    {% if journal.is_archived is True%}
        <h1>This journal is not available</h1>
    {% else %}
    <header>
        {% if journal.cover_img %}
            <img src="{{ journal.cover_img.url }}"/>
        {% endif %}
        <h1>{{journal.title}}</h1>
        <a href="{% url 'core:profile' journal.user.profile.pk %}">{{journal.user.username}}</a>
        {{journal.description}} 
    </header>
    <div>
        <h3>Likes: {{likes.count}}</h3>
        <form action="{% url 'core:journal_likes' pk=journal.pk %}">
            {% csrf_token %}
            <button type="submit">Appreciate Journal</button>
        </form>
        <form action="{% url 'core:journal_unlike' pk=journal.pk %}">
            {% csrf_token %}
        <button type="submit">Undo Appreciation</button>
        </form>
    </div>
    <section>
        <div>
            {% for entry in entries%}
                    <h4><a href="{% url 'core:entry_landing' pk=entry.pk %}">{{entry.title}}</a></h4>
                    {% for img in entry.image.all %}
                        {% if forloop.counter == 1%}
                            <img src="{{img.image.url}}">
                        {% endif %}
                    {% endfor %}  
            {% endfor %}
        </div>

    </section>
    <section>
        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            {{commentForm.as_p}}
            <input type="submit" value="Submit" />
        </form>
    </section>
    <!-- <section>
        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            {{commentForm.as_p}}
            <input type="submit" value="Submit" />
        </form>
    </section> -->
    <section>
        {% if comments.count > 0 %}
            {% for comment in comments %}
            {% if comment.is_parent %}
            <div>  
                {% if comment.is_archived is True %}
                    <h4>This comment has been deleted</h4>
                {%else%}
                    <div>
                        <a href="{% url 'core:profile' pk=comment.user.profile.pk %}"><img src="{{comment.user.profile_img.url}}"></a>
                        <h4>{{comment.user.username}}</h4>
                        <p>{{ comment.created_at }}</p>
                        </div>
                        <p>{{comment.comment}}</p>
                        <div>
                            {% for key, value in likeCounts.items %}
                                {% if key == comment.id %}
                                    <h3>Likes: {{value}}</h3>
                                {% endif %}
                            {% endfor %}
                            <form action="{% url 'core:comment_likes' pk=comment.pk %}">
                                {% csrf_token %}
                                <button type="submit">Appreciate Comment</button>
                            </form>
                            <form action="{% url 'core:comment_unlike' pk=comment.pk %}">
                                {% csrf_token %}
                                <button type="submit">Undo Appreciation</button>
                            </form>
                        </div>
                        {% if request.user == comment.user %}
                            <div>
                                <form action="{% url 'core:archive_comment' pk=comment.pk %}" method="POST">
                                    {% csrf_token %}
                                    <button name="archive" value="archive">Archive Comment</button>
                                </form>
                                <a href="{% url 'core:edit_comment' pk=comment.pk %}"><button>Edit Comment</button></a>
                            </div>
                        {% endif %}
                {%endif%}
                <form action="{% url 'core:reply_comment' pk=comment.pk %}" method="POST" enctype="multipart/form-data" >
                {% csrf_token %}
                {{commentForm.as_p}}
                <button type="submit" value="submit">Reply to Comment</button>
                </form>
                {% for child_comment in comment.children %}
                    {% if child_comment.is_archived is True %}
                        <h4>This comment has been deleted</h4>
                    {%else%}
                    <div>
                    <a href="{% url 'core:profile' pk=child_comment.user.profile.pk %}"><img src="{{comment.user.profile_img.url}}"></a>
                        <h4>{{child_comment.user.username}}</h4>
                        <p>{{ child_comment.created_at }}</p>
                    </div>
                    <p>{{child_comment.comment}}</p>
                    <div>
                        {% for key, value in likeCounts.items %}
                            {% if key == child_comment.id %}
                                <h3>Likes: {{value}}</h3>
                            {% endif %}
                        {% endfor %}
                        <form action="{% url 'core:comment_likes' pk=child_comment.pk %}">
                            {% csrf_token %}
                            <button type="submit">Appreciate Comment</button>
                        </form>
                        <form action="{% url 'core:comment_unlike' pk=child_comment.pk %}">
                            {% csrf_token %}
                            <button type="submit">Undo Appreciation</button>
                        </form>
                    </div>
                    {% if request.user == child_comment.user %}
    
                        <div>
                            <form action="{% url 'core:archive_comment' pk=child_comment.pk %}" method="POST">
                                {% csrf_token %}
                                <button name="archive" value="archive">Archive Comment</button>
                            </form>
                            <a href="{% url 'core:edit_comment' pk=child_comment.pk %}"><button>Edit Comment</button></a>
                        </div>
                    {%endif%}
                {% endif %}
                </div>
        </div>  
    
            {% endfor %}
            {% endif %}
            {% endfor %}
            
        {% endif %}
    </section>
{% endif %}
</main>

{% endblock %}