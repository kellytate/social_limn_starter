{% extends 'base.html' %}

{% block content %}
<main>
    {% if entry.is_archived is True%}
        <h1>This Entry is no longer available</h1>
    {% else %}
    <header class="container">
        <h1>{{entry.title}}</h1>
        <a href="{% url 'core:profile' pk=entry.journal.user.id %}">
            <p>By: {{entry.journal.user.username}}</p>
        </a>
        <p>Created On: {{entry.created_at}}</p>
        <a href="{% url 'core:journal_profile' pk=entry.journal.id %}">
            <p>
                {{entry.journal.title}}
            </p>
        </a>
    </header>
    {% if request.user == entry.journal.user %}
        <div class="container">
            <a href="{% url 'core:update_entry' pk=entry.id %}">
                <button class="btn btn-outline-light">Update Entry</button>
            </a>
            <form action="{% url 'core:archive_entry' pk=entry.pk %}" method="POST">
                {% csrf_token %}
                <button class="btn btn-outline-light" name="archive" value="archive">Archive Entry</button>
            </form>
        </div>
    {% endif %}
    {% if song %}
    {% with song.all|first as entrySong %}
        <div class="iframely-embed">
            <div class="iframely-responsive">
                <a data-iframely-url href="{{entrySong.source_url}}"></a>
            </div>
        </div>
        {% endwith %}
    {% endif %}
    <div class="container">
        <h3>Likes: {{likes.count}}</h3>
        <form action="{% url 'core:entry_likes' pk=entry.pk %}">
            {% csrf_token %}
            <button class="btn btn-outline-light" type="submit">Appreciate Entry</button>
        </form>
        <form action="{% url 'core:entry_unlike' pk=entry.pk %}">
            {% csrf_token %}
        <button class="btn btn-outline-light" type="submit">Undo Appreciation</button>
        </form>
    </div>
    {% if place %}
        <img src="{{placeMap}}">
    {% endif %}
    <section class="container">
        <h2>Capture:</h2>
        <p>{{entry.body}}</p>
    </section>
    {% if images.count > 0 %}
    <section   id="nanogallery2">
    </section>
    {% elif videos.count > 0%}
    <section   id="nanogallery2">
    </section>
    {% endif %}
    <section class="container">
        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            {{commentForm.as_p}}
            <input class="btn btn-outline-light" type="submit" value="Submit" />
        </form>
    </section>
    <section>
    {% if comments.count > 0 %}
        {% for comment in comments %}
        {% if comment.is_parent %}
        <div>  
            {% if comment.is_archived is True %}
                <h4>This comment has been deleted</h4>
            {%else%}
                <div>
                    <a href="{% url 'core:profile' pk=comment.user.profile.pk %}"><img src="{{comment.user.profile_img.url}}"></a>
                    <h4>{{comment.user.username}}</h4>
                    <p>{{ comment.created_at }}</p>
                    </div>
                    <p>{{comment.comment}}</p>
                    <div>
                        {% for key, value in likeCounts.items %}
                            {% if key == comment.id %}
                                <h3>Likes: {{value}}</h3>
                            {% endif %}
                        {% endfor %}
                        <form action="{% url 'core:comment_likes' pk=comment.pk %}">
                            {% csrf_token %}
                            <button class="btn btn-outline-light"type="submit">Appreciate Comment</button>
                        </form>
                        <form action="{% url 'core:comment_unlike' pk=comment.pk %}">
                            {% csrf_token %}
                            <button class="btn btn-outline-light"type="submit">Undo Appreciation</button>
                        </form>
                    </div>
                    {% if request.user == comment.user %}
                        <div>
                            <form action="{% url 'core:archive_comment' pk=comment.pk %}" method="POST">
                                {% csrf_token %}
                                <button class="btn btn-outline-light"name="archive" value="archive">Archive Comment</button>
                            </form>
                            <a href="{% url 'core:edit_comment' pk=comment.pk %}"><button>Edit Comment</button></a>
                        </div>
                    {% endif %}
            {%endif%}
            <form action="{% url 'core:reply_comment' pk=comment.pk %}" method="POST" enctype="multipart/form-data" >
            {% csrf_token %}
            {{commentForm.as_p}}
            <button class="btn btn-outline-light"type="submit" value="submit">Reply to Comment</button>
            </form>
            {% for child_comment in comment.children %}
                {% if child_comment.is_archived is True %}
                    <h4>This comment has been deleted</h4>
                {%else%}
                <div>
                <a href="{% url 'core:profile' pk=child_comment.user.profile.pk %}"><img src="{{comment.user.profile_img.url}}"></a>
                    <h4>{{child_comment.user.username}}</h4>
                    <p>{{ child_comment.created_at }}</p>
                </div>
                <p>{{child_comment.comment}}</p>
                <div>
                    {% for key, value in likeCounts.items %}
                        {% if key == child_comment.id %}
                            <h3>Likes: {{value}}</h3>
                        {% endif %}
                    {% endfor %}
                    <form action="{% url 'core:comment_likes' pk=child_comment.pk %}">
                        {% csrf_token %}
                        <button class="btn btn-outline-light"type="submit">Appreciate Comment</button>
                    </form>
                    <form action="{% url 'core:comment_unlike' pk=child_comment.pk %}">
                        {% csrf_token %}
                        <button class="btn btn-outline-light"type="submit">Undo Appreciation</button>
                    </form>
                </div>
                {% if request.user == child_comment.user %}

                    <div>
                        <form action="{% url 'core:archive_comment' pk=child_comment.pk %}" method="POST">
                            {% csrf_token %}
                            <button class="btn btn-outline-light"name="archive" value="archive">Archive Comment</button>
                        </form>
                        <a href="{% url 'core:edit_comment' pk=child_comment.pk %}"><button>Edit Comment</button></a>
                    </div>
                {%endif%}
            {% endif %}
            </div>
    </div>  

        {% endfor %}
        {% endif %}
        {% endfor %}
        
    {% endif %}
    <!--<div id="embed-iframe"></div>-->
</section>
{% endif %}

<script async src="//cdn.iframe.ly/embed.js?api_key={{frame_key}}"></script>


<!-- <script src="https://open.spotify.com/embed-podcast/iframe-api/v1" async></script>
<script async src="//cdn.iframe.ly/embed.js?api_key={{frame_key}}"></script>
    <script>
    window.onSpotifyIframeApiReady = (IFrameAPI) => {
  let element = document.getElementById('embed-iframe');
  let options = {
    uri: 'spotify:track:1H4Y9uW4N0LsxJUz0VnaPJ'
    };
  let callback = (EmbedController) => {};
  IFrameAPI.createController(element, options, callback);
};
</script> -->
<script>
     $(document).ready(function () {
        const dataitems=[]
        let data = {{items|safe}}
        for (var i=0;i<data.length;i++) {
            dataitems.push(JSON.parse(data[i]))
        }

        jQuery("#nanogallery2").nanogallery2({
      items: dataitems,
      galleryMosaic : [                       // default layout
            { w: 2, h: 2, c: 1, r: 1 },
            { w: 1, h: 1, c: 3, r: 1 },
            { w: 1, h: 1, c: 3, r: 2 },
            { w: 1, h: 2, c: 4, r: 1 },
            { w: 2, h: 1, c: 5, r: 1 },
            { w: 2, h: 2, c: 5, r: 2 },
            { w: 1, h: 1, c: 4, r: 3 },
            { w: 2, h: 1, c: 2, r: 3 },
            { w: 1, h: 2, c: 1, r: 3 },
            { w: 1, h: 1, c: 2, r: 4 },
            { w: 2, h: 1, c: 3, r: 4 },
            { w: 1, h: 1, c: 5, r: 4 },
            { w: 1, h: 1, c: 6, r: 4 }
          ],
          galleryMosaicXS : [                     // layout for XS width
            { w: 2, h: 2, c: 1, r: 1 },
            { w: 1, h: 1, c: 3, r: 1 },
            { w: 1, h: 1, c: 3, r: 2 },
            { w: 1, h: 2, c: 1, r: 3 },
            { w: 2, h: 1, c: 2, r: 3 },
            { w: 1, h: 1, c: 2, r: 4 },
            { w: 1, h: 1, c: 3, r: 4 }
          ],
          galleryMosaicSM : [                     // layout for SM width
            { w: 2, h: 2, c: 1, r: 1 },
            { w: 1, h: 1, c: 3, r: 1 },
            { w: 1, h: 1, c: 3, r: 2 },
            { w: 1, h: 2, c: 1, r: 3 },
            { w: 2, h: 1, c: 2, r: 3 },
            { w: 1, h: 1, c: 2, r: 4 },
            { w: 1, h: 1, c: 3, r: 4 }
          ],
          galleryMaxRows: 1,
          galleryDisplayMode: 'rows',
          gallerySorting: 'random',
          thumbnailDisplayOrder: 'random',

          thumbnailHeight: '180', thumbnailWidth: '220',
          thumbnailAlignment: 'scaled',
          thumbnailGutterWidth: 0, thumbnailGutterHeight: 0,
          thumbnailBorderHorizontal: 0, thumbnailBorderVertical: 0,

          thumbnailToolbarImage: null,
          thumbnailToolbarAlbum: null,
          thumbnailLabel: { display: false },

          // DISPLAY ANIMATION
          // for gallery
          galleryDisplayTransitionDuration: 1500,
          // for thumbnails
          thumbnailDisplayTransition: 'imageSlideUp',
          thumbnailDisplayTransitionDuration: 1200,
          thumbnailDisplayTransitionEasing: 'easeInOutQuint',
          thumbnailDisplayInterval: 60,

          // THUMBNAIL HOVER ANIMATION
          thumbnailBuildInit2: 'image_scale_1.15',
          thumbnailHoverEffect2: 'thumbnail_scale_1.00_1.05_300|image_scale_1.15_1.00',
          touchAnimation: true,
          touchAutoOpenDelay: 500,

          // LIGHTBOX
          viewerToolbar: { display: false },
          viewerTools:    {
            topLeft:   'label',
            topRight:  'shareButton, rotateLeft, rotateRight, fullscreenButton, closeButton'
          },

          // GALLERY THEME
          galleryTheme : { 
            thumbnail: { background: '#111' },
          },
					
          // DEEP LINKING
          locationHash: true

    });
  });
</script>

</main>

{% endblock %}