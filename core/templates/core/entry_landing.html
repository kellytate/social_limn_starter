{% extends 'base.html' %}

{% block content %}
<main>
    {% if entry.is_archived is True%}
        <h1>This Entry is no longer available</h1>
    {% else %}
    <header>
        <h1>{{entry.title}}</h1>
        <a href="{% url 'core:profile' pk=entry.journal.user.id %}">
            <p>By: {{entry.journal.user.username}}</p>
        </a>
        <p>Created On: {{entry.created_at}}</p>
        <a href="{% url 'core:journal_profile' pk=entry.journal.id %}">
            <p>
                {{entry.journal.title}}
            </p>
        </a>
    </header>
    {% if request.user == entry.journal.user %}
        <div>
            <a href="{% url 'core:update_entry' pk=entry.id %}">
                <button>Update Entry</button>
            </a>
            <form action="{% url 'core:archive_entry' pk=entry.pk %}" method="POST">
                {% csrf_token %}
                <button name="archive" value="archive">Archive Entry</button>
            </form>
        </div>
    {% endif %}
    {% if song %}
    {% with song.all|first as entrySong %}
        <div class="iframely-embed">
            <div class="iframely-responsive">
                <a data-iframely-url href="{{entrySong.source_url}}"></a>
            </div>
        </div>
        {% endwith %}
    {% endif %}
    <div>
        <h3>Likes: {{likes.count}}</h3>
        <form action="{% url 'core:entry_likes' pk=entry.pk %}">
            {% csrf_token %}
            <button type="submit">Appreciate Entry</button>
        </form>
        <form action="{% url 'core:entry_unlike' pk=entry.pk %}">
            {% csrf_token %}
        <button type="submit">Undo Appreciation</button>
        </form>

    </div>
    <section>
        <h2>Capture:</h2>
        <p>{{entry.body}}</p>
    </section>
    {% if images.count > 0 %}
    <section>
        {% for img in images %}
        <img src="{{img.image.url}}"/>
        {% endfor %}
    </section>
    {% endif %}
    <section>
        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            {{commentForm.as_p}}
            <input type="submit" value="Submit" />
        </form>
    </section>
    <section>
    {% if comments.count > 0 %}
        {% for comment in comments %}
        {% if comment.is_parent %}
        <div>  
            {% if comment.is_archived is True %}
                <h4>This comment has been deleted</h4>
            {%else%}
                <div>
                    <a href="{% url 'core:profile' pk=comment.user.profile.pk %}"><img src="{{comment.user.profile_img.url}}"></a>
                    <h4>{{comment.user.username}}</h4>
                    <p>{{ comment.created_at }}</p>
                    </div>
                    <p>{{comment.comment}}</p>
                    <div>
                        {% for key, value in likeCounts.items %}
                            {% if key == comment.id %}
                                <h3>Likes: {{value}}</h3>
                            {% endif %}
                        {% endfor %}
                        <form action="{% url 'core:comment_likes' pk=comment.pk %}">
                            {% csrf_token %}
                            <button type="submit">Appreciate Comment</button>
                        </form>
                        <form action="{% url 'core:comment_unlike' pk=comment.pk %}">
                            {% csrf_token %}
                            <button type="submit">Undo Appreciation</button>
                        </form>
                    </div>
                    {% if request.user == comment.user %}
                        <div>
                            <form action="{% url 'core:archive_comment' pk=comment.pk %}" method="POST">
                                {% csrf_token %}
                                <button name="archive" value="archive">Archive Comment</button>
                            </form>
                            <a href="{% url 'core:edit_comment' pk=comment.pk %}"><button>Edit Comment</button></a>
                        </div>
                    {% endif %}
            {%endif%}
            <form action="{% url 'core:reply_comment' pk=comment.pk %}" method="POST" enctype="multipart/form-data" >
            {% csrf_token %}
            {{commentForm.as_p}}
            <button type="submit" value="submit">Reply to Comment</button>
            </form>
            {% for child_comment in comment.children %}
                {% if child_comment.is_archived is True %}
                    <h4>This comment has been deleted</h4>
                {%else%}
                <div>
                <a href="{% url 'core:profile' pk=child_comment.user.profile.pk %}"><img src="{{comment.user.profile_img.url}}"></a>
                    <h4>{{child_comment.user.username}}</h4>
                    <p>{{ child_comment.created_at }}</p>
                </div>
                <p>{{child_comment.comment}}</p>
                <div>
                    {% for key, value in likeCounts.items %}
                        {% if key == child_comment.id %}
                            <h3>Likes: {{value}}</h3>
                        {% endif %}
                    {% endfor %}
                    <form action="{% url 'core:comment_likes' pk=child_comment.pk %}">
                        {% csrf_token %}
                        <button type="submit">Appreciate Comment</button>
                    </form>
                    <form action="{% url 'core:comment_unlike' pk=child_comment.pk %}">
                        {% csrf_token %}
                        <button type="submit">Undo Appreciation</button>
                    </form>
                </div>
                {% if request.user == child_comment.user %}

                    <div>
                        <form action="{% url 'core:archive_comment' pk=child_comment.pk %}" method="POST">
                            {% csrf_token %}
                            <button name="archive" value="archive">Archive Comment</button>
                        </form>
                        <a href="{% url 'core:edit_comment' pk=child_comment.pk %}"><button>Edit Comment</button></a>
                    </div>
                {%endif%}
            {% endif %}
            </div>
    </div>  

        {% endfor %}
        {% endif %}
        {% endfor %}
        
    {% endif %}
</section>
{% endif %}
<script async src="//cdn.iframe.ly/embed.js?api_key={{frame_key}}"></script>
</main>

{% endblock %}